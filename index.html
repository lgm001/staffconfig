<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ID4me Outlook Profile Generator</title>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: 2rem auto; }
    label, input, select { display: block; width: 100%; margin-bottom: 1rem; }
    button { padding: 0.5rem 1rem; font-size: 1rem; }
    #instructions { display: none; margin-top: 2rem; background: #f4f4f4; padding: 1rem; border-left: 4px solid #333; }
    pre { background: #eee; padding: 0.5rem; }
    #disclaimer {
      margin: 2rem 0;
      background: #fff3cd;
      border: 1px solid #ffeeba;
      padding: 1rem;
      border-radius: 5px;
      color: #856404;
    }
    .checkbox-block {
      display: inline-block;
      margin-bottom: 1rem;
    }
    .checkbox-block input[type="checkbox"],
    .checkbox-block label {
      display: inline-block;
      vertical-align: middle;
      margin: 0;
    }
    .checkbox-warning {
      display: inline-block;
      margin-left: 1.5rem;
      color: red;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>ID4me Outlook Profile Generator</h1>

  <div id="disclaimer">
    <strong>Notice:</strong> This tool is intended for authorized internal use only. If you were not given access to this site through official channels, please do not proceed.
  </div>

  <label for="userSelect">Select your user:</label>
  <select id="userSelect">
    <option value="" disabled selected>Select a user</option>
  </select>

  <label for="userEmail">User Email:</label>
  <input type="email" id="userEmail" placeholder="user@domain.com">

  <label for="displayName">Display Name:</label>
  <input type="text" id="displayName" placeholder="Joe The User">

  <div class="checkbox-block">
  <input type="checkbox" id="keepProfile" checked>
  <label for="keepProfile">Keep existing Outlook profiles</label>
  <div class="checkbox-warning">&#9888; DO NOT uncheck unless instructed</div>
</div>

  <button id="generateBtn" disabled>Generate PowerShell Script</button>

  <div id="instructions">
    <h2>⚠️ Read Before Running</h2>
    <p>This PowerShell script modifies the Windows Registry to preconfigure Outlook for Autodiscover setup. It may trigger warnings depending on your system policy.</p>
    <p><strong>To run:</strong></p>
    <pre>Right-click the downloaded <code>.ps1</code> file → "Run with PowerShell"</pre>
    <p>If blocked by security policy:</p>
    <pre>Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass</pre>
    <p>Then re-run the script.</p>
  </div>

 <script>
    const generateBtn = document.getElementById('generateBtn');
    const emailInput = document.getElementById('userEmail');
    const nameInput = document.getElementById('displayName');
    const keepProfileCheckbox = document.getElementById('keepProfile');

    function validateForm() {
      const isValid = emailInput.value.trim() !== '' && nameInput.value.trim() !== '';
      generateBtn.disabled = !isValid;
    }

    emailInput.addEventListener('input', validateForm);
    nameInput.addEventListener('input', validateForm);

    fetch('users.json')
      .then(res => res.json())
      .then(users => {
        const select = document.getElementById('userSelect');

        users.forEach(user => {
          const option = document.createElement('option');
          option.value = user.email;
          option.textContent = user.name;
          select.appendChild(option);
        });

        select.addEventListener('change', () => {
          const selectedUser = users.find(u => u.email === select.value);
          emailInput.value = selectedUser.email;
          nameInput.value = selectedUser.name;
          validateForm();
        });
      });

    generateBtn.addEventListener('click', () => {
      const email = emailInput.value;
      const name = nameInput.value;
      const keepExisting = keepProfileCheckbox.checked;

      const psScript = `
$baseProfileName = "OutlookAutodiscover"
$userEmail = "${email}"
$displayName = "${name}"

$regPath = "HKCU:\\Software\\Microsoft\\Office\\16.0\\Outlook\\AutoDiscover"
New-Item -Path $regPath -Force | Out-Null
New-ItemProperty -Path $regPath -Name "ZeroConfigExchange" -Value 1 -PropertyType DWord -Force | Out-Null

$profileName = $baseProfileName
if (Test-Path "HKCU:\Software\Microsoft\Office\16.0\Outlook\Profiles\$baseProfileName") {
  $profileName = "${baseProfileName}_id4mecom"
}

$profPath = "HKCU:\\Software\\Microsoft\\Office\\16.0\\Outlook\\Profiles\\$profileName"
New-Item -Path $profPath -Force | Out-Null

Set-ItemProperty -Path "HKCU:\\Software\\Microsoft\\Office\\16.0\\Outlook" -Name "DefaultProfile" -Value $profileName
Set-ItemProperty -Path "HKCU:\\Software\\Microsoft\\Office\\16.0\\Outlook" -Name "DefaultProfileName" -Value $profileName

Set-ItemProperty -Path "HKCU:\Software\Microsoft\Office\16.0\Outlook" -Name "PromptForProfile" -Value 1 -Type DWord

Write-Host "New profile '$profileName' created. Outlook will now prompt for a profile on launch."
`;

      const blob = new Blob([psScript], { type: "text/plain" });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = "generate_outlook_profile.ps1";
      link.click();

      document.getElementById('instructions').style.display = 'block';
    });
  </script>
</body>
</html>
